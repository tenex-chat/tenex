<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message History Deduplication Architecture Analysis</title>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-code: #0f0f1a;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --accent-blue: #4facfe;
            --accent-purple: #9b59b6;
            --accent-green: #2ecc71;
            --accent-orange: #e67e22;
            --accent-red: #e74c3c;
            --accent-yellow: #f1c40f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.7;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 4px solid var(--accent-blue);
        }

        .section h2 {
            color: var(--accent-blue);
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h3 {
            color: var(--text-primary);
            font-size: 1.2rem;
            margin: 25px 0 15px;
        }

        p {
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .problem-highlight {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid var(--accent-red);
        }

        .recommendation {
            background: rgba(46, 204, 113, 0.1);
            border-left: 4px solid var(--accent-green);
        }

        .proposal {
            border-left: 4px solid var(--accent-purple);
        }

        code {
            background: var(--bg-code);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9rem;
            color: var(--accent-yellow);
        }

        pre {
            background: var(--bg-code);
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.1);
        }

        pre code {
            padding: 0;
            background: none;
        }

        .pros-cons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .pros, .cons {
            padding: 20px;
            border-radius: 8px;
        }

        .pros {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .cons {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .pros h4 {
            color: var(--accent-green);
            margin-bottom: 10px;
        }

        .cons h4 {
            color: var(--accent-red);
            margin-bottom: 10px;
        }

        ul {
            list-style-position: inside;
            color: var(--text-secondary);
        }

        li {
            margin-bottom: 8px;
        }

        .diagram-container {
            background: var(--bg-code);
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
        }

        .diagram-container svg {
            display: block;
            margin: 0 auto;
        }

        .complexity-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .complexity-low {
            background: rgba(46, 204, 113, 0.2);
            color: var(--accent-green);
        }

        .complexity-medium {
            background: rgba(241, 196, 15, 0.2);
            color: var(--accent-yellow);
        }

        .complexity-high {
            background: rgba(231, 76, 60, 0.2);
            color: var(--accent-red);
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .comparison-table th {
            color: var(--accent-blue);
            font-weight: 600;
        }

        .rating {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 3px;
        }

        .rating-filled {
            background: var(--accent-green);
        }

        .rating-empty {
            background: rgba(255,255,255,0.2);
        }

        .callout {
            background: rgba(79, 172, 254, 0.1);
            border: 1px solid rgba(79, 172, 254, 0.3);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .callout-title {
            color: var(--accent-blue);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .toc {
            background: rgba(155, 89, 182, 0.1);
            border: 1px solid rgba(155, 89, 182, 0.3);
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 40px;
        }

        .toc h3 {
            color: var(--accent-purple);
            margin-bottom: 15px;
        }

        .toc ol {
            list-style-position: inside;
            color: var(--text-secondary);
        }

        .toc a {
            color: var(--text-primary);
            text-decoration: none;
        }

        .toc a:hover {
            color: var(--accent-blue);
        }

        @media (max-width: 768px) {
            .pros-cons {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Message History Deduplication</h1>
            <p class="subtitle">
                Architectural Analysis: Handling Provider-Specific History Management in TENEX
            </p>
        </header>

        <nav class="toc">
            <h3>Table of Contents</h3>
            <ol>
                <li><a href="#problem">Problem Statement</a></li>
                <li><a href="#current">Current Architecture</a></li>
                <li><a href="#constraints">Design Constraints</a></li>
                <li><a href="#proposal1">Proposal 1: Provider Capability Interface</a></li>
                <li><a href="#proposal2">Proposal 2: Delta Message Strategy</a></li>
                <li><a href="#proposal3">Proposal 3: Message Bridge Service</a></li>
                <li><a href="#proposal4">Proposal 4: Dual-Mode Message Building</a></li>
                <li><a href="#proposal5">Proposal 5: Session Boundary Markers</a></li>
                <li><a href="#comparison">Comparison Matrix</a></li>
                <li><a href="#recommendation">Recommendation</a></li>
            </ol>
        </nav>

        <section id="problem" class="section problem-highlight">
            <h2>üî¥ Problem Statement</h2>
            <p>
                Claude Code maintains its own internal conversation history through session resumption
                (<code>resume: sessionId</code>). Meanwhile, TENEX sends the full message history via
                the <code>messages[]</code> array to support providers that don't maintain state
                (Ollama, OpenRouter, etc.).
            </p>
            <p>
                <strong>Result:</strong> When resuming a Claude Code session, the conversation history
                is duplicated ‚Äî once from Claude Code's internal state, once from the messages array
                TENEX sends.
            </p>

            <div class="diagram-container">
                <svg width="900" height="380" viewBox="0 0 900 380">
                    <!-- Background -->
                    <rect width="900" height="380" fill="#0f0f1a"/>

                    <!-- Title -->
                    <text x="450" y="30" text-anchor="middle" fill="#e74c3c" font-size="16" font-weight="bold">CURRENT BEHAVIOR: Message Duplication Problem</text>

                    <!-- ConversationStore Box -->
                    <rect x="50" y="60" width="200" height="250" rx="8" fill="#1a1a2e" stroke="#4facfe" stroke-width="2"/>
                    <text x="150" y="85" text-anchor="middle" fill="#4facfe" font-size="14" font-weight="bold">ConversationStore</text>

                    <!-- Messages in ConversationStore -->
                    <rect x="70" y="100" width="160" height="30" rx="4" fill="#2ecc71" fill-opacity="0.3" stroke="#2ecc71"/>
                    <text x="150" y="120" text-anchor="middle" fill="#e8e8e8" font-size="11">Message 1</text>

                    <rect x="70" y="140" width="160" height="30" rx="4" fill="#2ecc71" fill-opacity="0.3" stroke="#2ecc71"/>
                    <text x="150" y="160" text-anchor="middle" fill="#e8e8e8" font-size="11">Message 2</text>

                    <rect x="70" y="180" width="160" height="30" rx="4" fill="#2ecc71" fill-opacity="0.3" stroke="#2ecc71"/>
                    <text x="150" y="200" text-anchor="middle" fill="#e8e8e8" font-size="11">Message 3</text>

                    <rect x="70" y="220" width="160" height="30" rx="4" fill="#f1c40f" fill-opacity="0.3" stroke="#f1c40f"/>
                    <text x="150" y="240" text-anchor="middle" fill="#f1c40f" font-size="11">Message 4 (new)</text>

                    <!-- Arrow -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#4facfe"/>
                        </marker>
                    </defs>
                    <line x1="260" y1="185" x2="340" y2="185" stroke="#4facfe" stroke-width="3" marker-end="url(#arrowhead)"/>
                    <text x="300" y="175" text-anchor="middle" fill="#a0a0a0" font-size="11">messages[]</text>

                    <!-- Claude Code Box -->
                    <rect x="350" y="60" width="250" height="250" rx="8" fill="#1a1a2e" stroke="#9b59b6" stroke-width="2"/>
                    <text x="475" y="85" text-anchor="middle" fill="#9b59b6" font-size="14" font-weight="bold">Claude Code Session</text>

                    <!-- Internal History Label -->
                    <text x="475" y="108" text-anchor="middle" fill="#a0a0a0" font-size="10">Internal History (from resume)</text>

                    <!-- Messages from Internal History -->
                    <rect x="370" y="118" width="105" height="25" rx="4" fill="#e74c3c" fill-opacity="0.3" stroke="#e74c3c"/>
                    <text x="422" y="135" text-anchor="middle" fill="#e8e8e8" font-size="10">Message 1</text>

                    <rect x="370" y="148" width="105" height="25" rx="4" fill="#e74c3c" fill-opacity="0.3" stroke="#e74c3c"/>
                    <text x="422" y="165" text-anchor="middle" fill="#e8e8e8" font-size="10">Message 2</text>

                    <rect x="370" y="178" width="105" height="25" rx="4" fill="#e74c3c" fill-opacity="0.3" stroke="#e74c3c"/>
                    <text x="422" y="195" text-anchor="middle" fill="#e8e8e8" font-size="10">Message 3</text>

                    <!-- Messages from messages[] array -->
                    <text x="475" y="218" text-anchor="middle" fill="#a0a0a0" font-size="10">+ messages[] array</text>

                    <rect x="480" y="118" width="105" height="25" rx="4" fill="#e74c3c" fill-opacity="0.3" stroke="#e74c3c"/>
                    <text x="532" y="135" text-anchor="middle" fill="#e8e8e8" font-size="10">Message 1</text>

                    <rect x="480" y="148" width="105" height="25" rx="4" fill="#e74c3c" fill-opacity="0.3" stroke="#e74c3c"/>
                    <text x="532" y="165" text-anchor="middle" fill="#e8e8e8" font-size="10">Message 2</text>

                    <rect x="480" y="178" width="105" height="25" rx="4" fill="#e74c3c" fill-opacity="0.3" stroke="#e74c3c"/>
                    <text x="532" y="195" text-anchor="middle" fill="#e8e8e8" font-size="10">Message 3</text>

                    <rect x="480" y="228" width="105" height="25" rx="4" fill="#f1c40f" fill-opacity="0.3" stroke="#f1c40f"/>
                    <text x="532" y="245" text-anchor="middle" fill="#f1c40f" font-size="10">Message 4</text>

                    <!-- Duplicate indicator -->
                    <text x="475" y="280" text-anchor="middle" fill="#e74c3c" font-size="12" font-weight="bold">‚ö†Ô∏è DUPLICATED!</text>

                    <!-- Result Box -->
                    <rect x="620" y="60" width="250" height="250" rx="8" fill="#1a1a2e" stroke="#e74c3c" stroke-width="2"/>
                    <text x="745" y="85" text-anchor="middle" fill="#e74c3c" font-size="14" font-weight="bold">What Claude Sees</text>

                    <rect x="640" y="100" width="210" height="25" rx="4" fill="#e74c3c" fill-opacity="0.2" stroke="#e74c3c" stroke-dasharray="4"/>
                    <text x="745" y="117" text-anchor="middle" fill="#e74c3c" font-size="10">Message 1 (duplicate)</text>

                    <rect x="640" y="130" width="210" height="25" rx="4" fill="#e74c3c" fill-opacity="0.2" stroke="#e74c3c" stroke-dasharray="4"/>
                    <text x="745" y="147" text-anchor="middle" fill="#e74c3c" font-size="10">Message 2 (duplicate)</text>

                    <rect x="640" y="160" width="210" height="25" rx="4" fill="#e74c3c" fill-opacity="0.2" stroke="#e74c3c" stroke-dasharray="4"/>
                    <text x="745" y="177" text-anchor="middle" fill="#e74c3c" font-size="10">Message 3 (duplicate)</text>

                    <rect x="640" y="190" width="210" height="25" rx="4" fill="#2ecc71" fill-opacity="0.3" stroke="#2ecc71"/>
                    <text x="745" y="207" text-anchor="middle" fill="#e8e8e8" font-size="10">Message 1 (internal)</text>

                    <rect x="640" y="220" width="210" height="25" rx="4" fill="#2ecc71" fill-opacity="0.3" stroke="#2ecc71"/>
                    <text x="745" y="237" text-anchor="middle" fill="#e8e8e8" font-size="10">Message 2 (internal)</text>

                    <rect x="640" y="250" width="210" height="25" rx="4" fill="#2ecc71" fill-opacity="0.3" stroke="#2ecc71"/>
                    <text x="745" y="267" text-anchor="middle" fill="#e8e8e8" font-size="10">Message 3 (internal)</text>

                    <rect x="640" y="280" width="210" height="25" rx="4" fill="#f1c40f" fill-opacity="0.3" stroke="#f1c40f"/>
                    <text x="745" y="297" text-anchor="middle" fill="#f1c40f" font-size="10">Message 4 (new)</text>

                    <!-- Bottom summary -->
                    <rect x="50" y="330" width="820" height="40" rx="8" fill="#e74c3c" fill-opacity="0.1" stroke="#e74c3c"/>
                    <text x="460" y="355" text-anchor="middle" fill="#e74c3c" font-size="13">Messages 1-3 appear TWICE ‚Üí Wasted tokens, potential confusion, higher costs</text>
                </svg>
            </div>

            <h3>Why This Matters</h3>
            <ul>
                <li><strong>Token waste:</strong> Duplicate messages consume context window unnecessarily</li>
                <li><strong>Confusion:</strong> Model may see contradictory or confusing duplicate context</li>
                <li><strong>Cost:</strong> More tokens = higher API costs</li>
                <li><strong>Degraded quality:</strong> Duplicates can confuse the model's understanding of conversation state</li>
            </ul>
        </section>

        <section id="current" class="section">
            <h2>üìê Current Architecture</h2>

            <h3>Message Flow</h3>
            <div class="diagram-container">
                <svg width="900" height="300" viewBox="0 0 900 300">
                    <rect width="900" height="300" fill="#0f0f1a"/>

                    <!-- ConversationStore -->
                    <rect x="50" y="100" width="160" height="80" rx="8" fill="#1a1a2e" stroke="#4facfe" stroke-width="2"/>
                    <text x="130" y="135" text-anchor="middle" fill="#4facfe" font-size="12" font-weight="bold">Conversation</text>
                    <text x="130" y="155" text-anchor="middle" fill="#4facfe" font-size="12" font-weight="bold">Store</text>

                    <!-- Arrow 1 -->
                    <line x1="210" y1="140" x2="280" y2="140" stroke="#4facfe" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <text x="245" y="130" text-anchor="middle" fill="#a0a0a0" font-size="9">buildMessages</text>
                    <text x="245" y="158" text-anchor="middle" fill="#a0a0a0" font-size="9">ForRal()</text>

                    <!-- messages[] box -->
                    <rect x="290" y="100" width="120" height="80" rx="8" fill="#1a1a2e" stroke="#2ecc71" stroke-width="2"/>
                    <text x="350" y="145" text-anchor="middle" fill="#2ecc71" font-size="12" font-weight="bold">messages[]</text>

                    <!-- Arrow 2 -->
                    <line x1="410" y1="140" x2="480" y2="140" stroke="#4facfe" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <text x="445" y="130" text-anchor="middle" fill="#a0a0a0" font-size="9">prepareMessages</text>
                    <text x="445" y="158" text-anchor="middle" fill="#a0a0a0" font-size="9">ForRequest()</text>

                    <!-- LLMService -->
                    <rect x="490" y="80" width="180" height="120" rx="8" fill="#1a1a2e" stroke="#9b59b6" stroke-width="2"/>
                    <text x="580" y="105" text-anchor="middle" fill="#9b59b6" font-size="12" font-weight="bold">LLMService</text>

                    <!-- Code inside LLMService -->
                    <rect x="500" y="115" width="160" height="70" rx="4" fill="#0f0f1a"/>
                    <text x="510" y="132" fill="#f1c40f" font-size="9" font-family="monospace">if (claudeCode) {</text>
                    <text x="520" y="148" fill="#e8e8e8" font-size="9" font-family="monospace">resume: sessionId</text>
                    <text x="520" y="164" fill="#e74c3c" font-size="9" font-family="monospace">// STILL sends full</text>
                    <text x="520" y="178" fill="#e74c3c" font-size="9" font-family="monospace">// messages[] !</text>

                    <!-- Arrow 3 -->
                    <line x1="670" y1="140" x2="740" y2="140" stroke="#4facfe" stroke-width="2" marker-end="url(#arrowhead)"/>

                    <!-- Claude Code -->
                    <rect x="750" y="100" width="120" height="80" rx="8" fill="#1a1a2e" stroke="#e67e22" stroke-width="2"/>
                    <text x="810" y="135" text-anchor="middle" fill="#e67e22" font-size="12" font-weight="bold">Claude</text>
                    <text x="810" y="155" text-anchor="middle" fill="#e67e22" font-size="12" font-weight="bold">Code</text>

                    <!-- Labels at bottom -->
                    <text x="130" y="220" text-anchor="middle" fill="#a0a0a0" font-size="10">Single source</text>
                    <text x="130" y="235" text-anchor="middle" fill="#a0a0a0" font-size="10">of truth</text>

                    <text x="580" y="230" text-anchor="middle" fill="#a0a0a0" font-size="10">Sets resume option</text>
                    <text x="580" y="245" text-anchor="middle" fill="#a0a0a0" font-size="10">but sends ALL messages</text>

                    <text x="810" y="220" text-anchor="middle" fill="#a0a0a0" font-size="10">Has internal</text>
                    <text x="810" y="235" text-anchor="middle" fill="#a0a0a0" font-size="10">history too</text>
                </svg>
            </div>

            <h3>Key Components</h3>
            <ul>
                <li><code>AgentExecutor.executeStreaming()</code> - Builds messages from ConversationStore</li>
                <li><code>ConversationStore.buildMessagesForRal()</code> - Single source of truth for conversation</li>
                <li><code>LLMService.prepareMessagesForRequest()</code> - Applies provider-specific transforms</li>
                <li><code>SessionManager</code> - Tracks session IDs and last sent event IDs</li>
                <li><code>ClaudeCodeProvider</code> - Creates model with <code>resume</code> option</li>
            </ul>

            <h3>Provider Capabilities (Already Defined)</h3>
            <pre><code>// src/llm/providers/types.ts
export interface ProviderCapabilities {
    streaming: boolean;
    toolCalling: boolean;
    builtInTools: boolean;
    sessionResumption: boolean;  // ‚Üê Key capability!
    requiresApiKey: boolean;
    mcpSupport: boolean;
}</code></pre>
        </section>

        <section id="constraints" class="section">
            <h2>‚ö†Ô∏è Design Constraints</h2>

            <div class="callout">
                <div class="callout-title">Your Stated Preference</div>
                <p>
                    "It's probably better to not completely do away with Claude Code's internal message history,
                    since it's probably built in a way that works better for Claude Code than what we can achieve;
                    if we go that route we'll be chasing a moving target."
                </p>
            </div>

            <h3>Must-Have Requirements</h3>
            <ul>
                <li><strong>Support message injection:</strong> Supervision corrections, delegation results, etc. must still be injectable</li>
                <li><strong>Work with all providers:</strong> Ollama, OpenRouter still need full history</li>
                <li><strong>Preserve Claude Code's session benefits:</strong> Don't replace its internal history management</li>
                <li><strong>Keep AgentExecutor manageable:</strong> Don't add more complexity to the already complex file</li>
            </ul>

            <h3>Nice-to-Have</h3>
            <ul>
                <li>Minimal changes to existing code</li>
                <li>Clean separation of concerns</li>
                <li>Testable in isolation</li>
            </ul>
        </section>

        <section id="proposal2" class="section proposal">
            <h2>Proposal 2: Delta Message Strategy <span class="complexity-badge complexity-medium">Medium Complexity</span></h2>

            <p>
                Track a "checkpoint" (message index or event ID) marking what Claude Code has already seen.
                When resuming a session, only send messages after the checkpoint.
            </p>

            <h3>How It Works</h3>
            <div class="diagram-container">
                <svg width="900" height="450" viewBox="0 0 900 450">
                    <rect width="900" height="450" fill="#0f0f1a"/>

                    <text x="450" y="30" text-anchor="middle" fill="#4facfe" font-size="16" font-weight="bold">Delta Message Strategy</text>

                    <!-- Session 1 -->
                    <text x="225" y="60" text-anchor="middle" fill="#2ecc71" font-size="14" font-weight="bold">Session 1 (Initial)</text>

                    <rect x="50" y="75" width="350" height="180" rx="8" fill="#1a1a2e" stroke="#2ecc71" stroke-width="2"/>

                    <!-- Messages -->
                    <rect x="70" y="90" width="310" height="25" rx="4" fill="#2ecc71" fill-opacity="0.2" stroke="#2ecc71"/>
                    <text x="80" y="107" fill="#a0a0a0" font-size="10">[0]</text>
                    <text x="110" y="107" fill="#e8e8e8" font-size="11">System prompt</text>

                    <rect x="70" y="120" width="310" height="25" rx="4" fill="#2ecc71" fill-opacity="0.2" stroke="#2ecc71"/>
                    <text x="80" y="137" fill="#a0a0a0" font-size="10">[1]</text>
                    <text x="110" y="137" fill="#e8e8e8" font-size="11">User: "Help me build a feature..."</text>

                    <rect x="70" y="150" width="310" height="25" rx="4" fill="#2ecc71" fill-opacity="0.2" stroke="#2ecc71"/>
                    <text x="80" y="167" fill="#a0a0a0" font-size="10">[2]</text>
                    <text x="110" y="167" fill="#e8e8e8" font-size="11">Assistant: "Sure, I'll help..."</text>

                    <rect x="70" y="180" width="310" height="25" rx="4" fill="#2ecc71" fill-opacity="0.2" stroke="#2ecc71"/>
                    <text x="80" y="197" fill="#a0a0a0" font-size="10">[3]</text>
                    <text x="110" y="197" fill="#e8e8e8" font-size="11">Tool call: read_file</text>

                    <rect x="70" y="210" width="310" height="25" rx="4" fill="#f1c40f" fill-opacity="0.3" stroke="#f1c40f"/>
                    <text x="80" y="227" fill="#a0a0a0" font-size="10">[4]</text>
                    <text x="110" y="227" fill="#f1c40f" font-size="11">Assistant: "Done!" ‚Üê Checkpoint saved: 4</text>

                    <!-- Annotation -->
                    <text x="225" y="265" text-anchor="middle" fill="#a0a0a0" font-size="11">All messages [0-4] sent to Claude Code</text>

                    <!-- Session 2 -->
                    <text x="675" y="60" text-anchor="middle" fill="#9b59b6" font-size="14" font-weight="bold">Session 2 (Resume)</text>

                    <rect x="500" y="75" width="350" height="180" rx="8" fill="#1a1a2e" stroke="#9b59b6" stroke-width="2"/>

                    <!-- Grayed out old messages -->
                    <rect x="520" y="90" width="310" height="80" rx="4" fill="#1a1a2e" stroke="#a0a0a0" stroke-dasharray="4"/>
                    <text x="675" y="115" text-anchor="middle" fill="#a0a0a0" font-size="11">Messages [0-4]</text>
                    <text x="675" y="135" text-anchor="middle" fill="#a0a0a0" font-size="10">Already in Claude Code's internal history</text>
                    <text x="675" y="155" text-anchor="middle" fill="#a0a0a0" font-size="10">(NOT sent again)</text>

                    <!-- New messages only -->
                    <rect x="520" y="180" width="310" height="25" rx="4" fill="#9b59b6" fill-opacity="0.3" stroke="#9b59b6"/>
                    <text x="530" y="197" fill="#a0a0a0" font-size="10">[5]</text>
                    <text x="560" y="197" fill="#e8e8e8" font-size="11">User: "Now add a test for that"</text>

                    <rect x="520" y="210" width="310" height="25" rx="4" fill="#e67e22" fill-opacity="0.3" stroke="#e67e22"/>
                    <text x="530" y="227" fill="#a0a0a0" font-size="10">[6]</text>
                    <text x="560" y="227" fill="#e67e22" font-size="11">[Injection] Supervision correction</text>

                    <!-- Annotation -->
                    <text x="675" y="265" text-anchor="middle" fill="#2ecc71" font-size="11">Only messages [5-6] sent (delta)</text>

                    <!-- Result Box -->
                    <rect x="200" y="290" width="500" height="140" rx="8" fill="#1a1a2e" stroke="#2ecc71" stroke-width="2"/>
                    <text x="450" y="315" text-anchor="middle" fill="#2ecc71" font-size="14" font-weight="bold">What Claude Code Sees</text>

                    <rect x="220" y="330" width="200" height="30" rx="4" fill="#4facfe" fill-opacity="0.2" stroke="#4facfe"/>
                    <text x="320" y="350" text-anchor="middle" fill="#e8e8e8" font-size="11">Internal history [0-4]</text>

                    <text x="440" y="350" text-anchor="middle" fill="#4facfe" font-size="16">+</text>

                    <rect x="480" y="330" width="200" height="30" rx="4" fill="#9b59b6" fill-opacity="0.2" stroke="#9b59b6"/>
                    <text x="580" y="350" text-anchor="middle" fill="#e8e8e8" font-size="11">Delta messages [5-6]</text>

                    <text x="450" y="385" text-anchor="middle" fill="#2ecc71" font-size="12">=</text>

                    <rect x="300" y="395" width="300" height="25" rx="4" fill="#2ecc71" fill-opacity="0.2" stroke="#2ecc71"/>
                    <text x="450" y="412" text-anchor="middle" fill="#2ecc71" font-size="12" font-weight="bold">Complete history, no duplicates!</text>
                </svg>
            </div>

            <h3>Implementation</h3>
            <pre><code>// Extend SessionManager with checkpoint tracking
interface SessionData {
    sessionId?: string;
    lastSentEventId?: string;
    lastMessageIndex?: number;  // ‚Üê New: checkpoint marker
}

// In ConversationStore.buildMessagesForRal()
async buildMessagesForRal(
    agentPubkey: string,
    ralNumber: number,
    options?: { afterMessageIndex?: number }
): Promise<ModelMessage[]> {
    const startIndex = options?.afterMessageIndex !== undefined
        ? options.afterMessageIndex + 1
        : 0;
    // Only process messages from startIndex onwards
    const relevantMessages = this.state.messages.slice(startIndex);
    // ... rest of building logic
}</code></pre>

            <div class="pros-cons">
                <div class="pros">
                    <h4>‚úÖ Pros</h4>
                    <ul>
                        <li>Simple concept: checkpoint + delta</li>
                        <li>Works naturally with injections (added after checkpoint)</li>
                        <li>Can extend existing SessionManager</li>
                        <li>No new services needed</li>
                    </ul>
                </div>
                <div class="cons">
                    <h4>‚ùå Cons</h4>
                    <ul>
                        <li>Checkpoint tracking adds state complexity</li>
                        <li>Edge case: What if checkpoint is invalid/stale?</li>
                        <li>Must handle session invalidation (workingDirectory change)</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="proposal1" class="section proposal">
            <h2>Proposal 1: Provider Capability Interface <span class="complexity-badge complexity-low">Low Complexity</span></h2>

            <p>
                Extend the existing <code>ProviderCapabilities</code> interface with a new property
                indicating how the provider handles history. Message building logic adapts based on this.
            </p>

            <div class="diagram-container">
                <svg width="900" height="280" viewBox="0 0 900 280">
                    <rect width="900" height="280" fill="#0f0f1a"/>

                    <text x="450" y="30" text-anchor="middle" fill="#4facfe" font-size="16" font-weight="bold">Capability-Driven Message Building</text>

                    <!-- Provider Capabilities Box -->
                    <rect x="50" y="60" width="250" height="120" rx="8" fill="#1a1a2e" stroke="#4facfe" stroke-width="2"/>
                    <text x="175" y="85" text-anchor="middle" fill="#4facfe" font-size="12" font-weight="bold">ProviderCapabilities</text>

                    <text x="70" y="110" fill="#f1c40f" font-size="10" font-family="monospace">sessionResumption: true</text>
                    <text x="70" y="130" fill="#2ecc71" font-size="10" font-family="monospace">historyManagement:</text>
                    <text x="90" y="150" fill="#2ecc71" font-size="10" font-family="monospace">'session-stateful' ‚Üê NEW</text>

                    <!-- Arrow -->
                    <line x1="300" y1="120" x2="380" y2="120" stroke="#4facfe" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <text x="340" y="110" text-anchor="middle" fill="#a0a0a0" font-size="10">check</text>

                    <!-- Decision Diamond -->
                    <polygon points="450,70 530,120 450,170 370,120" fill="#1a1a2e" stroke="#9b59b6" stroke-width="2"/>
                    <text x="450" y="115" text-anchor="middle" fill="#9b59b6" font-size="10">session-</text>
                    <text x="450" y="130" text-anchor="middle" fill="#9b59b6" font-size="10">stateful?</text>

                    <!-- Yes path -->
                    <line x1="530" y1="120" x2="600" y2="120" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <text x="565" y="110" text-anchor="middle" fill="#2ecc71" font-size="10">YES</text>

                    <rect x="610" y="90" width="130" height="60" rx="8" fill="#2ecc71" fill-opacity="0.2" stroke="#2ecc71" stroke-width="2"/>
                    <text x="675" y="115" text-anchor="middle" fill="#2ecc71" font-size="11" font-weight="bold">Delta Mode</text>
                    <text x="675" y="135" text-anchor="middle" fill="#e8e8e8" font-size="10">Send only new</text>

                    <!-- No path -->
                    <line x1="450" y1="170" x2="450" y2="200" stroke="#e67e22" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <text x="465" y="190" fill="#e67e22" font-size="10">NO</text>

                    <rect x="385" y="210" width="130" height="60" rx="8" fill="#e67e22" fill-opacity="0.2" stroke="#e67e22" stroke-width="2"/>
                    <text x="450" y="235" text-anchor="middle" fill="#e67e22" font-size="11" font-weight="bold">Full Mode</text>
                    <text x="450" y="255" text-anchor="middle" fill="#e8e8e8" font-size="10">Send all history</text>

                    <!-- Provider examples -->
                    <rect x="750" y="60" width="130" height="90" rx="8" fill="#1a1a2e" stroke="#a0a0a0" stroke-width="1"/>
                    <text x="815" y="85" text-anchor="middle" fill="#a0a0a0" font-size="11" font-weight="bold">Examples</text>
                    <text x="760" y="105" fill="#2ecc71" font-size="10">‚Ä¢ Claude Code</text>
                    <text x="760" y="120" fill="#2ecc71" font-size="10">‚Ä¢ Codex CLI</text>
                    <text x="760" y="140" fill="#e67e22" font-size="10">‚Ä¢ OpenRouter</text>
                    <text x="760" y="155" fill="#e67e22" font-size="10">‚Ä¢ Ollama</text>
                </svg>
            </div>

            <h3>Implementation</h3>
            <pre><code>// Extend ProviderCapabilities
interface ProviderCapabilities {
    // ... existing
    historyManagement: 'stateless' | 'session-stateful';
}

// ClaudeCodeProvider sets it
static readonly METADATA: ProviderMetadata = {
    capabilities: {
        sessionResumption: true,
        historyManagement: 'session-stateful',  // ‚Üê NEW
    }
}</code></pre>

            <div class="pros-cons">
                <div class="pros">
                    <h4>‚úÖ Pros</h4>
                    <ul>
                        <li>Uses existing capability system</li>
                        <li>Minimal code changes</li>
                        <li>Easy to extend for future providers</li>
                        <li>Self-documenting</li>
                    </ul>
                </div>
                <div class="cons">
                    <h4>‚ùå Cons</h4>
                    <ul>
                        <li>Only describes WHAT, not HOW</li>
                        <li>Needs to combine with P2 for checkpoint logic</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="proposal3" class="section proposal">
            <h2>Proposal 3: Message Bridge Service <span class="complexity-badge complexity-high">High Complexity</span></h2>

            <p>
                Create a new service that sits between AgentExecutor and LLMService, responsible for
                mediating message building based on provider capabilities.
            </p>

            <div class="diagram-container">
                <svg width="900" height="320" viewBox="0 0 900 320">
                    <rect width="900" height="320" fill="#0f0f1a"/>

                    <text x="450" y="30" text-anchor="middle" fill="#4facfe" font-size="16" font-weight="bold">Message Bridge Service Architecture</text>

                    <!-- AgentExecutor -->
                    <rect x="50" y="100" width="150" height="70" rx="8" fill="#1a1a2e" stroke="#4facfe" stroke-width="2"/>
                    <text x="125" y="140" text-anchor="middle" fill="#4facfe" font-size="12" font-weight="bold">AgentExecutor</text>

                    <!-- Arrow -->
                    <line x1="200" y1="135" x2="280" y2="135" stroke="#4facfe" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <text x="240" y="125" text-anchor="middle" fill="#a0a0a0" font-size="9">"Give me</text>
                    <text x="240" y="150" text-anchor="middle" fill="#a0a0a0" font-size="9">messages"</text>

                    <!-- MessageBridgeService -->
                    <rect x="290" y="60" width="220" height="160" rx="8" fill="#9b59b6" fill-opacity="0.2" stroke="#9b59b6" stroke-width="2"/>
                    <text x="400" y="85" text-anchor="middle" fill="#9b59b6" font-size="12" font-weight="bold">MessageBridgeService</text>
                    <text x="400" y="105" text-anchor="middle" fill="#9b59b6" font-size="10">(NEW)</text>

                    <text x="310" y="130" fill="#e8e8e8" font-size="10">‚Ä¢ Knows provider capabilities</text>
                    <text x="310" y="150" fill="#e8e8e8" font-size="10">‚Ä¢ Knows session state</text>
                    <text x="310" y="170" fill="#e8e8e8" font-size="10">‚Ä¢ Tracks checkpoint</text>
                    <text x="310" y="190" fill="#e8e8e8" font-size="10">‚Ä¢ Handles delta vs full</text>

                    <!-- Arrow to ConversationStore -->
                    <line x1="400" y1="220" x2="400" y2="260" stroke="#4facfe" stroke-width="2" marker-end="url(#arrowhead)"/>

                    <!-- ConversationStore -->
                    <rect x="290" y="260" width="220" height="50" rx="8" fill="#1a1a2e" stroke="#2ecc71" stroke-width="2"/>
                    <text x="400" y="290" text-anchor="middle" fill="#2ecc71" font-size="12" font-weight="bold">ConversationStore</text>

                    <!-- Arrow to LLMService -->
                    <line x1="510" y1="135" x2="590" y2="135" stroke="#4facfe" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <text x="550" y="125" text-anchor="middle" fill="#a0a0a0" font-size="9">prepared</text>
                    <text x="550" y="150" text-anchor="middle" fill="#a0a0a0" font-size="9">messages</text>

                    <!-- LLMService -->
                    <rect x="600" y="100" width="150" height="70" rx="8" fill="#1a1a2e" stroke="#e67e22" stroke-width="2"/>
                    <text x="675" y="140" text-anchor="middle" fill="#e67e22" font-size="12" font-weight="bold">LLMService</text>

                    <!-- Benefit callout -->
                    <rect x="600" y="200" width="250" height="80" rx="8" fill="#2ecc71" fill-opacity="0.1" stroke="#2ecc71" stroke-dasharray="4"/>
                    <text x="725" y="225" text-anchor="middle" fill="#2ecc71" font-size="11" font-weight="bold">Benefit</text>
                    <text x="725" y="245" text-anchor="middle" fill="#e8e8e8" font-size="10">AgentExecutor stays clean</text>
                    <text x="725" y="265" text-anchor="middle" fill="#e8e8e8" font-size="10">All complexity in one place</text>
                </svg>
            </div>

            <div class="pros-cons">
                <div class="pros">
                    <h4>‚úÖ Pros</h4>
                    <ul>
                        <li>Complete separation of concerns</li>
                        <li>AgentExecutor stays clean</li>
                        <li>Testable in isolation</li>
                        <li>Single place for all history logic</li>
                    </ul>
                </div>
                <div class="cons">
                    <h4>‚ùå Cons</h4>
                    <ul>
                        <li>New service = more files, more indirection</li>
                        <li>Risk of over-engineering</li>
                        <li>Need to thread dependencies through</li>
                        <li>Higher initial cost</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="proposal4" class="section proposal">
            <h2>Proposal 4: Dual-Mode Message Building <span class="complexity-badge complexity-medium">Medium Complexity</span></h2>

            <p>
                Modify <code>ConversationStore.buildMessagesForRal()</code> to accept a mode parameter.
                The mode is determined by the caller based on provider capabilities.
            </p>

            <pre><code>// Extend ConversationStore method signature
async buildMessagesForRal(
    agentPubkey: string,
    ralNumber: number,
    options?: { afterMessageIndex?: number }
): Promise<ModelMessage[]></code></pre>

            <div class="pros-cons">
                <div class="pros">
                    <h4>‚úÖ Pros</h4>
                    <ul>
                        <li>Extends existing code naturally</li>
                        <li>No new services</li>
                        <li>ConversationStore already owns message building</li>
                        <li>Backward compatible (options optional)</li>
                    </ul>
                </div>
                <div class="cons">
                    <h4>‚ùå Cons</h4>
                    <ul>
                        <li>ConversationStore gains more responsibility</li>
                        <li>Caller must understand provider capabilities</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="proposal5" class="section proposal">
            <h2>Proposal 5: Session Boundary Markers <span class="complexity-badge complexity-low">Low Complexity</span></h2>

            <p>
                Embed "session boundary" markers directly in the conversation store. When building messages
                for a resumed session, skip all messages before the most recent boundary.
            </p>

            <div class="diagram-container">
                <svg width="900" height="280" viewBox="0 0 900 280">
                    <rect width="900" height="280" fill="#0f0f1a"/>

                    <text x="450" y="30" text-anchor="middle" fill="#4facfe" font-size="16" font-weight="bold">Session Boundary Markers</text>

                    <!-- Messages list -->
                    <rect x="250" y="50" width="400" height="220" rx="8" fill="#1a1a2e" stroke="#4facfe" stroke-width="2"/>
                    <text x="450" y="75" text-anchor="middle" fill="#4facfe" font-size="12" font-weight="bold">ConversationStore Messages</text>

                    <rect x="270" y="90" width="360" height="25" rx="4" fill="#a0a0a0" fill-opacity="0.2" stroke="#a0a0a0"/>
                    <text x="450" y="107" text-anchor="middle" fill="#a0a0a0" font-size="10">User: "Help me build..."</text>

                    <rect x="270" y="120" width="360" height="25" rx="4" fill="#a0a0a0" fill-opacity="0.2" stroke="#a0a0a0"/>
                    <text x="450" y="137" text-anchor="middle" fill="#a0a0a0" font-size="10">Assistant: "Sure, I'll..."</text>

                    <rect x="270" y="150" width="360" height="25" rx="4" fill="#a0a0a0" fill-opacity="0.2" stroke="#a0a0a0"/>
                    <text x="450" y="167" text-anchor="middle" fill="#a0a0a0" font-size="10">Assistant: "Done!"</text>

                    <!-- Boundary marker -->
                    <rect x="270" y="180" width="360" height="25" rx="4" fill="#e74c3c" fill-opacity="0.3" stroke="#e74c3c" stroke-width="2"/>
                    <text x="450" y="197" text-anchor="middle" fill="#e74c3c" font-size="10" font-weight="bold">‚îÄ‚îÄ SESSION BOUNDARY ‚îÄ‚îÄ (isSessionBoundary: true)</text>

                    <rect x="270" y="210" width="360" height="25" rx="4" fill="#2ecc71" fill-opacity="0.3" stroke="#2ecc71"/>
                    <text x="450" y="227" text-anchor="middle" fill="#2ecc71" font-size="10">User: "Now add a test" ‚Üê Only this sent on resume</text>

                    <rect x="270" y="240" width="360" height="25" rx="4" fill="#2ecc71" fill-opacity="0.3" stroke="#2ecc71"/>
                    <text x="450" y="257" text-anchor="middle" fill="#2ecc71" font-size="10">[Injection] Supervision correction</text>
                </svg>
            </div>

            <div class="pros-cons">
                <div class="pros">
                    <h4>‚úÖ Pros</h4>
                    <ul>
                        <li>Self-contained in ConversationStore</li>
                        <li>No external state tracking</li>
                        <li>Survives daemon restarts (persisted)</li>
                    </ul>
                </div>
                <div class="cons">
                    <h4>‚ùå Cons</h4>
                    <ul>
                        <li>Pollutes message history with markers</li>
                        <li>Doesn't work if session wasn't cleanly ended</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="comparison" class="section">
            <h2>üìä Comparison Matrix</h2>

            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Criteria</th>
                        <th>P1: Capability</th>
                        <th>P2: Delta</th>
                        <th>P3: Bridge</th>
                        <th>P4: Dual-Mode</th>
                        <th>P5: Boundary</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Implementation Complexity</td>
                        <td><span class="rating rating-filled"></span><span class="rating rating-empty"></span><span class="rating rating-empty"></span></td>
                        <td><span class="rating rating-filled"></span><span class="rating rating-filled"></span><span class="rating rating-empty"></span></td>
                        <td><span class="rating rating-filled"></span><span class="rating rating-filled"></span><span class="rating rating-filled"></span></td>
                        <td><span class="rating rating-filled"></span><span class="rating rating-filled"></span><span class="rating rating-empty"></span></td>
                        <td><span class="rating rating-filled"></span><span class="rating rating-empty"></span><span class="rating rating-empty"></span></td>
                    </tr>
                    <tr>
                        <td>AgentExecutor Changes</td>
                        <td>Minimal</td>
                        <td>Small</td>
                        <td>Moderate</td>
                        <td>Small</td>
                        <td>Small</td>
                    </tr>
                    <tr>
                        <td>Testability</td>
                        <td>Good</td>
                        <td>Good</td>
                        <td>Excellent</td>
                        <td>Good</td>
                        <td>Fair</td>
                    </tr>
                    <tr>
                        <td>Future Provider Support</td>
                        <td>Excellent</td>
                        <td>Good</td>
                        <td>Excellent</td>
                        <td>Good</td>
                        <td>Fair</td>
                    </tr>
                    <tr>
                        <td>Injection Handling</td>
                        <td>N/A</td>
                        <td>Natural</td>
                        <td>Explicit</td>
                        <td>Natural</td>
                        <td>Natural</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="recommendation" class="section recommendation">
            <h2>üéØ Recommendation: Hybrid (P1 + P2 + P4)</h2>

            <p>
                Combine three proposals into a cohesive solution that balances simplicity and maintainability.
            </p>

            <div class="diagram-container">
                <svg width="900" height="500" viewBox="0 0 900 500">
                    <rect width="900" height="500" fill="#0f0f1a"/>

                    <text x="450" y="30" text-anchor="middle" fill="#2ecc71" font-size="16" font-weight="bold">Recommended Solution Flow</text>

                    <!-- Step 1 -->
                    <rect x="50" y="60" width="800" height="90" rx="8" fill="#1a1a2e" stroke="#4facfe" stroke-width="2"/>
                    <text x="70" y="85" fill="#4facfe" font-size="12" font-weight="bold">Step 1: Check Provider Capability</text>
                    <text x="70" y="110" fill="#f1c40f" font-size="11" font-family="monospace">const isStateful = provider.capabilities.historyManagement === 'session-stateful';</text>
                    <text x="70" y="130" fill="#f1c40f" font-size="11" font-family="monospace">const hasSession = session.sessionId !== undefined;</text>

                    <!-- Arrow -->
                    <line x1="450" y1="150" x2="450" y2="180" stroke="#4facfe" stroke-width="2" marker-end="url(#arrowhead)"/>

                    <!-- Step 2 -->
                    <rect x="50" y="190" width="800" height="90" rx="8" fill="#1a1a2e" stroke="#9b59b6" stroke-width="2"/>
                    <text x="70" y="215" fill="#9b59b6" font-size="12" font-weight="bold">Step 2: Build Messages with Mode</text>
                    <text x="70" y="240" fill="#f1c40f" font-size="11" font-family="monospace">const messages = isStateful && hasSession</text>
                    <text x="70" y="260" fill="#f1c40f" font-size="11" font-family="monospace">  ? await store.buildMessagesForRal(pubkey, ral, { afterMessageIndex: checkpoint })</text>
                    <text x="70" y="280" fill="#f1c40f" font-size="11" font-family="monospace">  : await store.buildMessagesForRal(pubkey, ral);  // full history</text>

                    <!-- Arrow -->
                    <line x1="450" y1="280" x2="450" y2="310" stroke="#4facfe" stroke-width="2" marker-end="url(#arrowhead)"/>

                    <!-- Step 3 -->
                    <rect x="50" y="320" width="800" height="70" rx="8" fill="#1a1a2e" stroke="#e67e22" stroke-width="2"/>
                    <text x="70" y="345" fill="#e67e22" font-size="12" font-weight="bold">Step 3: Stream to LLM</text>
                    <text x="70" y="370" fill="#f1c40f" font-size="11" font-family="monospace">llmService.stream(messages, ...);  // Claude Code gets delta only, no duplication!</text>

                    <!-- Arrow -->
                    <line x1="450" y1="390" x2="450" y2="420" stroke="#4facfe" stroke-width="2" marker-end="url(#arrowhead)"/>

                    <!-- Step 4 -->
                    <rect x="50" y="430" width="800" height="60" rx="8" fill="#1a1a2e" stroke="#2ecc71" stroke-width="2"/>
                    <text x="70" y="455" fill="#2ecc71" font-size="12" font-weight="bold">Step 4: Update Checkpoint</text>
                    <text x="70" y="475" fill="#f1c40f" font-size="11" font-family="monospace">sessionManager.setCheckpoint(conversationStore.getMessageCount() - 1);</text>
                </svg>
            </div>

            <h3>Files to Modify</h3>
            <ol>
                <li><code>src/llm/providers/types.ts</code> - Add <code>historyManagement</code> capability</li>
                <li><code>src/llm/providers/agent/ClaudeCodeProvider.ts</code> - Set capability to <code>'session-stateful'</code></li>
                <li><code>src/agents/execution/SessionManager.ts</code> - Add checkpoint tracking</li>
                <li><code>src/conversations/ConversationStore.ts</code> - Add <code>afterMessageIndex</code> option</li>
                <li><code>src/agents/execution/AgentExecutor.ts</code> - Use capability to choose mode (~10 lines)</li>
            </ol>

            <h3>Why This Works</h3>
            <ul>
                <li><strong>Injections work naturally:</strong> They're added AFTER checkpoint is saved, always included in delta</li>
                <li><strong>Minimal new code:</strong> No new services, just extends existing components</li>
                <li><strong>AgentExecutor stays clean:</strong> Just a capability check and option passing</li>
                <li><strong>Testable:</strong> Each piece independently testable</li>
                <li><strong>Future-proof:</strong> Easy to add new providers with different history behaviors</li>
            </ul>
        </section>

        <footer style="text-align: center; margin-top: 60px; color: var(--text-secondary);">
            <p>Generated for TENEX Architecture Analysis ‚Ä¢ January 2026</p>
        </footer>
    </div>
</body>
</html>
