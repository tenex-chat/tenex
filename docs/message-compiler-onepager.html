<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MessageCompiler One Pager</title>
  <style>
    :root {
      --ink: #1a1a19;
      --muted: #4e4b45;
      --paper: #f7f1e7;
      --paper-2: #efe7dc;
      --accent: #c35b36;
      --accent-2: #2b6a5f;
      --accent-3: #caa13b;
      --line: rgba(26, 26, 25, 0.12);
      --shadow: 0 18px 40px rgba(26, 26, 25, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background:
        radial-gradient(900px 520px at 5% -10%, rgba(195, 91, 54, 0.18), transparent 60%),
        radial-gradient(800px 480px at 95% 0%, rgba(43, 106, 95, 0.14), transparent 62%),
        linear-gradient(180deg, #f6efe5 0%, #f0ece6 45%, #f6f2ea 100%);
      color: var(--ink);
      font-family: "Palatino Linotype", "Book Antiqua", "Palatino", serif;
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 40px 24px 64px;
      position: relative;
      z-index: 1;
    }

    header {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.8);
      border-radius: 18px;
      padding: 28px 32px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-size: 12px;
      font-family: "Gill Sans", "Futura", "Avenir Next", sans-serif;
      color: var(--accent-2);
      margin-bottom: 12px;
    }

    h1 {
      margin: 0 0 12px;
      font-size: clamp(28px, 4vw, 42px);
      line-height: 1.05;
      font-family: "Futura", "Gill Sans", "Avenir Next", sans-serif;
    }

    p {
      margin: 0 0 10px;
      line-height: 1.6;
      color: var(--muted);
      font-size: 16px;
    }

    section { margin-top: 28px; }

    h2 {
      font-size: 20px;
      margin: 0 0 12px;
      font-family: "Futura", "Gill Sans", "Avenir Next", sans-serif;
    }

    h3 {
      font-size: 16px;
      margin: 0 0 8px;
      font-family: "Futura", "Gill Sans", "Avenir Next", sans-serif;
    }

    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .card {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.8);
      border-radius: 14px;
      padding: 18px 20px;
      box-shadow: 0 10px 24px rgba(26, 26, 25, 0.08);
    }

    .tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-family: "Gill Sans", "Futura", "Avenir Next", sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: var(--paper-2);
      border: 1px solid var(--line);
      color: var(--accent);
      margin-bottom: 8px;
    }

    ul {
      padding-left: 18px;
      margin: 8px 0 0;
      line-height: 1.55;
      color: var(--muted);
      font-size: 15px;
    }

    .diagram {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      overflow-x: auto;
    }

    .diagram svg {
      width: 100%;
      height: auto;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }

    .pill {
      border: 1px solid var(--line);
      background: var(--paper);
      border-radius: 999px;
      padding: 8px 12px;
      font-family: "Gill Sans", "Futura", "Avenir Next", sans-serif;
      font-size: 12px;
      color: var(--ink);
    }

    .callout {
      border: 1px dashed var(--line);
      background: rgba(255, 255, 255, 0.85);
      border-radius: 12px;
      padding: 16px 18px;
    }

    .orbit {
      position: fixed;
      border-radius: 50%;
      opacity: 0.12;
      pointer-events: none;
      z-index: 0;
    }

    .orbit.one {
      width: 320px;
      height: 320px;
      background: #e1a058;
      top: 8%;
      left: -80px;
    }

    .orbit.two {
      width: 260px;
      height: 260px;
      background: #5a9c86;
      bottom: 10%;
      right: -60px;
    }

    .interactive {
      display: grid;
      gap: 16px;
      grid-template-columns: minmax(220px, 300px) 1fr;
      align-items: start;
    }

    .controls {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.85);
      border-radius: 14px;
      padding: 16px;
    }

    .control-group {
      margin-bottom: 12px;
    }

    .control-group label {
      display: block;
      font-family: "Gill Sans", "Futura", "Avenir Next", sans-serif;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent-2);
      margin-bottom: 6px;
    }

    select, input[type="number"], button {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
      font-family: "Gill Sans", "Futura", "Avenir Next", sans-serif;
      font-size: 14px;
      background: #fff;
      color: var(--ink);
    }

    button {
      background: var(--accent-2);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: transform 0.15s ease;
    }

    button:hover {
      transform: translateY(-1px);
    }

    .output {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 24px rgba(26, 26, 25, 0.08);
    }

    .output pre {
      margin: 0;
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.5;
      font-family: "SFMono-Regular", "Menlo", "Consolas", "Liberation Mono", monospace;
    }

    .legend {
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }

    @media (max-width: 880px) {
      .interactive {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="orbit one"></div>
  <div class="orbit two"></div>
  <main>
    <header>
      <div class="eyebrow">TENEX one pager</div>
      <h1>MessageCompiler design contract</h1>
      <p>
        Goal: prevent duplicate history for session-stateful providers (Claude Code) while
        preserving injections, tool results, and dynamic context.
      </p>
      <div class="pill-row">
        <div class="pill">AgentExecutor orchestrates</div>
        <div class="pill">MessageCompiler assembles</div>
        <div class="pill">Policy chooses full vs delta</div>
        <div class="pill">Static vs dynamic prompts</div>
      </div>
    </header>

    <section>
      <h2>Visual: end-to-end flow (AgentExecutor in context)</h2>
      <div class="diagram">
        <svg viewBox="0 0 980 320" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <style>
              .box { fill: #f9f4ec; stroke: #c9c2b8; stroke-width: 1.2; }
              .box-strong { fill: #f1e4d6; stroke: #c9c2b8; stroke-width: 1.4; }
              .title { font: 600 13px 'Gill Sans', 'Futura', sans-serif; fill: #1a1a19; }
              .text { font: 12px 'Gill Sans', 'Futura', sans-serif; fill: #4e4b45; }
              .arrow { stroke: #7c7368; stroke-width: 1.4; marker-end: url(#arrow); }
            </style>
            <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
              <path d="M 0 0 L 10 5 L 0 10 z" fill="#7c7368" />
            </marker>
          </defs>

          <rect class="box-strong" x="30" y="30" width="210" height="70" rx="10" />
          <text class="title" x="50" y="58">AgentExecutor</text>
          <text class="text" x="50" y="76">orchestrates execution</text>

          <rect class="box" x="280" y="30" width="180" height="70" rx="10" />
          <text class="title" x="300" y="58">Policy</text>
          <text class="text" x="300" y="76">full vs delta</text>

          <rect class="box" x="500" y="30" width="200" height="70" rx="10" />
          <text class="title" x="520" y="58">MessageCompiler</text>
          <text class="text" x="520" y="76">assembles messages[]</text>

          <rect class="box" x="730" y="30" width="200" height="70" rx="10" />
          <text class="title" x="750" y="58">LLMService</text>
          <text class="text" x="750" y="76">send to provider</text>

          <line class="arrow" x1="240" y1="65" x2="280" y2="65" />
          <line class="arrow" x1="460" y1="65" x2="500" y2="65" />
          <line class="arrow" x1="700" y1="65" x2="730" y2="65" />

          <rect class="box" x="60" y="150" width="220" height="60" rx="10" />
          <text class="title" x="80" y="178">ConversationStore</text>
          <text class="text" x="80" y="196">source of truth</text>

          <rect class="box" x="330" y="150" width="220" height="60" rx="10" />
          <text class="title" x="350" y="178">SessionManager</text>
          <text class="text" x="350" y="196">session + cursor</text>

          <rect class="box" x="600" y="150" width="300" height="60" rx="10" />
          <text class="title" x="620" y="178">Dynamic Context</text>
          <text class="text" x="620" y="196">todos, response context, nudges</text>

          <line class="arrow" x1="170" y1="100" x2="170" y2="150" />
          <line class="arrow" x1="440" y1="100" x2="440" y2="150" />
          <line class="arrow" x1="700" y1="100" x2="700" y2="150" />

          <line class="arrow" x1="170" y1="210" x2="520" y2="100" />
          <line class="arrow" x1="440" y1="210" x2="520" y2="100" />
          <line class="arrow" x1="750" y1="210" x2="520" y2="100" />
        </svg>
      </div>
    </section>

    <section>
      <h2>Interactive: messages[] builder</h2>
      <div class="interactive">
        <div class="controls">
          <div class="control-group">
            <label for="providerType">Provider type</label>
            <select id="providerType">
              <option value="stateless">Stateless (OpenRouter/Ollama/etc.)</option>
              <option value="stateful">Session-stateful (Claude Code)</option>
            </select>
          </div>
          <div class="control-group">
            <label for="hasSession">Active session</label>
            <select id="hasSession">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div class="control-group">
            <label for="cursor">Cursor (last sent index)</label>
            <input id="cursor" type="number" min="-1" value="3" />
          </div>
          <div class="control-group">
            <label for="ordering">Dynamic prompt ordering</label>
            <select id="ordering">
              <option value="after">After conversation (recommended)</option>
              <option value="before">Before conversation</option>
            </select>
          </div>
          <button id="render">Render messages[]</button>
          <p class="legend">Use cursor -1 to simulate "send everything".</p>
        </div>
        <div class="output">
          <pre id="output"></pre>
          <div class="legend">Legend: S = static system, D = dynamic system, C = conversation.</div>
        </div>
      </div>
    </section>

    <section>
      <h2>Design contract (summary)</h2>
      <div class="grid">
        <div class="card">
          <div class="tag">Inputs</div>
          <ul>
            <li>Provider memory model</li>
            <li>Session state (sessionId, cursor)</li>
            <li>ConversationStore</li>
            <li>Dynamic context (todos, response context, nudges)</li>
          </ul>
        </div>
        <div class="card">
          <div class="tag">Invariants</div>
          <ul>
            <li>Deterministic for same inputs</li>
            <li>Monotonic with cursor</li>
            <li>Idempotent when cursor is held</li>
          </ul>
        </div>
        <div class="card">
          <div class="tag">Non-goals</div>
          <ul>
            <li>Replacing provider internal memory</li>
            <li>Changing tool execution flow</li>
            <li>Replacing ConversationStore</li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <script>
    const sample = {
      staticPrompts: [
        { role: "system", label: "S1", content: "Agent identity + instructions" },
        { role: "system", label: "S2", content: "Project context + tools" },
      ],
      conversation: [
        { role: "user", label: "C0", content: "User: initial request" },
        { role: "assistant", label: "C1", content: "Assistant: plan" },
        { role: "assistant", label: "C2", content: "Tool call" },
        { role: "tool", label: "C3", content: "Tool result" },
        { role: "user", label: "C4", content: "User: add tests" },
      ],
      dynamicPrompts: [
        { role: "system", label: "D1", content: "Todo list" },
        { role: "system", label: "D2", content: "Response context + delegations" },
      ],
    };

    const outputEl = document.getElementById("output");
    const providerTypeEl = document.getElementById("providerType");
    const hasSessionEl = document.getElementById("hasSession");
    const cursorEl = document.getElementById("cursor");
    const orderingEl = document.getElementById("ordering");
    const renderButton = document.getElementById("render");

    function buildMessages() {
      const providerType = providerTypeEl.value;
      const hasSession = hasSessionEl.value === "yes";
      const ordering = orderingEl.value;
      const cursor = Number(cursorEl.value);

      const isStateful = providerType === "stateful";
      const shouldUseDelta = isStateful && hasSession && cursor >= -1;

      const conversation = shouldUseDelta
        ? sample.conversation.slice(Math.max(cursor + 1, 0))
        : sample.conversation;

      const messages = [];

      if (!isStateful || !hasSession) {
        messages.push(...sample.staticPrompts);
      }

      if (ordering === "before") {
        messages.push(...sample.dynamicPrompts.map(p => ({ ...p })));
      }

      messages.push(...conversation);

      if (ordering === "after") {
        messages.push(...sample.dynamicPrompts.map(p => ({ ...p })));
      }

      return {
        messages,
        meta: { isStateful, hasSession, cursor, ordering, shouldUseDelta },
      };
    }

    function render() {
      const { messages, meta } = buildMessages();

      const header = [
        `Provider: ${meta.isStateful ? "Session-stateful" : "Stateless"}`,
        `Active session: ${meta.hasSession ? "yes" : "no"}`,
        `Cursor: ${meta.cursor}`,
        `Ordering: dynamic ${meta.ordering}`,
        `Delta mode: ${meta.shouldUseDelta ? "yes" : "no"}`,
        "",
        "messages[]:",
      ].join("\n");

      const body = messages
        .map((m, idx) => {
          return `${String(idx).padStart(2, "0")} | ${m.label} | ${m.role} | ${m.content}`;
        })
        .join("\n");

      outputEl.textContent = `${header}\n${body}`;
    }

    renderButton.addEventListener("click", render);
    render();
  </script>
</body>
</html>
